<form [formGroup]="filterForm" class="filters-form">
  <div class="filters filters-top">
    <div class="d-flex justify-content-end mt-2">
      <button color="accent" matButton="elevated" (click)="resetFilters()">Reset Filter</button>
    </div>
    <!-- Reset -->

    <!-- <mat-form-field>
    <mat-label>State</mat-label>
    <mat-select [(ngModel)]="stateSearchText" multiple>
      @for (state of filteredStates; track state) {
        <mat-option [value]="state">{{ state.name }}</mat-option>
      }
    </mat-select>
  </mat-form-field> -->
    <!-- <div class="d-flex justify-content-between align-items-center mb-1 mt-2">
      <span class="filter-label">State</span>

      <div class="btn-group-sm">
        <button type="button" class="btn btn-sm btn-link" (click)="selectStateStatus()">
          Select all
        </button>
        |
        <button type="button" class="btn btn-sm btn-link" (click)="selectStateStatus()">
          Deselect all
        </button>
      </div>
    </div> -->
    <mat-form-field appearance="outline" class="w-100 mt-3">
      <mat-label>State</mat-label>

      <!-- <mat-select formControlName="stateId" multiple [compareWith]="compareStates"> -->
      <mat-select formControlName="stateId" multiple>
        <!-- Header row inside the panel -->
        <div class="select-actions">
          <button
            matButton="elevated"
            color="primary"
            type="button"
            (click)="selectAllStates(true); $event.stopPropagation()"
          >
            All
          </button>
          <button
            matButton="elevated"
            color="accent"
            type="button"
            (click)="selectAllStates(false); $event.stopPropagation()"
          >
            Clear
          </button>
        </div>

        <!-- Actual options -->
        @for (state of filteredStates; track state) {
          <mat-option [value]="state._id">
            {{ state.name }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>

    <!-- State -->
    <!-- <label>State</label> -->
    <!-- <mat-form-field appearance="outline" class="full-width mt-3">
      <mat-label>State</mat-label>
      <input
        matInput
        type="text"
        placeholder="Search state..."
        [(ngModel)]="stateSearchText"
        (input)="selectedState = []; stateDropdownOpen = true"
        (focus)="stateDropdownOpen = true"
        [matAutocomplete]="stateAuto"
        class="state-search-box"
      />
      <mat-autocomplete
        #stateAuto="matAutocomplete"
        (optionSelected)="selectState($event.option.value)"
      >
        @for (s of filteredStates; track s._id) {
          <mat-option [value]="s" [class.selected]="selectedState.includes(s._id)">
            {{ s.name }}
          </mat-option>
        }
      </mat-autocomplete>
    </mat-form-field> -->

    <!-- Population Category -->
    <!-- <label>Population Category</label> -->
    <mat-form-field appearance="outline" class="full-width">
      <mat-label>Population Category</mat-label>
      <mat-select
        placeholder="Select population category"
        formControlName="populationCategory"
        (selectionChange)="onPopulationOrStateChange()"
      >
        <mat-option [value]="''">Select population category</mat-option>
        @for (p of populationCategories; track $index) {
          <mat-option [value]="p">{{ p }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <!-- City search -->
    <label class="filter-label">City</label>
    <mat-form-field appearance="outline" class="mat-small w-100">
      <input
        matInput
        type="text"
        formControlName="ulbId"
        placeholder="Search city..."
        class="city-search-box"
      />
    </mat-form-field>

    <!-- City multi-select (shown only when state + population selected) -->
    @if (selectedState && selectedPopulation && false) {
      <div>
        <mat-selection-list class="city-checkboxes scroll-box">
          @for (c of filteredCities; track $index) {
            <mat-list-option
              [value]="c.name"
              [selected]="selectedCities.includes(c.name)"
              (selectionChange)="toggleCitySelection(c)"
            >
              {{ c.name }}
            </mat-list-option>
          }
        </mat-selection-list>
      </div>
    }

    <!-- Year -->
    <label>Year</label>
    <mat-form-field appearance="outline" class="full-width">
      <mat-select placeholder="Select Year" formControlName="yearId">
        <mat-option [value]="''">Select Year</mat-option>
        @for (y of years; track $index) {
          <mat-option [value]="y.key">{{ y.value }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <!-- Document Type (grouped radios) -->
    <label>Document Type</label>
    <div class="grouped-dropdown">
      <mat-radio-group formControlName="docType" class="radio-options-vertical">
        @for (d of filters.documentTypes; track $index) {
          <div class="docType-group">
            <div class="group-option">
              <mat-radio-button [value]="d.key">
                {{ d.name }}
              </mat-radio-button>
            </div>
          </div>
        }
      </mat-radio-group>
    </div>

    <label>Audit Type</label>
    <!-- Audited / UnAudited (hide for 16th_fc) -->
    @if (selectedDocType !== '16th_fc') {
      <div class="audited-radio-container radio-options">
        <mat-radio-group formControlName="auditType">
          <mat-radio-button value="audited">Audited</mat-radio-button>
          <mat-radio-button value="unAudited">UnAudited</mat-radio-button>
        </mat-radio-group>
      </div>
    }

    <!-- Apply button -->
    <button mat-raised-button color="primary" class="apply-btn" (click)="applyFilters()">
      Apply Filter
    </button>
  </div>
</form>
