<div class="table-wrapper">
  <mat-card>
    <mat-card-title class="mx-3 mt-3">City Documents</mat-card-title>
    @if (activeFilterSummary) {
      <mat-card-subtitle>
        {{ activeFilterSummary }}
      </mat-card-subtitle>
    }

    <div class="table-container mt-2">
      <!-- Loader overlay -->
      @if (isTableLoading) {
        <div class="table-loader-overlay">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      }
      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z1 w-100">
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="$event ? toggleAllRows() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
              [aria-label]="checkboxLabel()"
            >
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox
              (click)="$event.stopPropagation()"
              (change)="$event ? selection.toggle(row) : null"
              [checked]="selection.isSelected(row)"
              [aria-label]="checkboxLabel(row)"
            >
            </mat-checkbox>
          </td>
        </ng-container>
        <!-- State -->
        <ng-container matColumnDef="state">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>State</th>
          <td mat-cell *matCellDef="let row">{{ row.stateName }}</td>
        </ng-container>

        <!-- City -->
        <ng-container matColumnDef="city">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>City</th>
          <td mat-cell *matCellDef="let row">
            <strong>{{ row.ulbCode }}</strong> <br />{{ row.ulbName }}
          </td>
        </ng-container>

        <!-- City -->
        <ng-container matColumnDef="ulbUploadedPdf">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Ulb Uploaded</th>
          <td mat-cell *matCellDef="let row">
            @if (row[`${filters.docType}`]) {
              <a [href]="row[`${filters.docType}`].url | toStorageUrl" target="_blank">
                {{ row[`${filters.docType}`].name}}</a
              >
            }
          </td>
        </ng-container>
        <ng-container matColumnDef="formStatus">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Form Status</th>
          <td mat-cell *matCellDef="let row">
            {{ MASTER_FORM_STATUS[row.currentFormStatus] || 'Unknown' }}
          </td>
        </ng-container>
        <ng-container matColumnDef="digitizeStatus">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Digitized Status</th>
          <td mat-cell *matCellDef="let row">
            @let statusText = getStatusText(row);
            <!-- <span class="badge badge-primary" [ngClass]="">{{ getStatusText(row) }}</span> -->
            <small
              class="badge rounded-pill text-bg-secondary px-2 py-1"
              [ngClass]="{
                'text-bg-success': statusText === 'Digitized',
                'text-bg-danger': statusText === 'Failed',
              }"
              >{{ statusText }}
            </small>
          </td>
        </ng-container>

        <!-- Population Category -->
        <!-- <ng-container matColumnDef="populationCategory">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Population Category</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.ulbPopulation | population: 'category' }}
                </td>
              </ng-container> -->

        <!-- Year -->
        <ng-container matColumnDef="year">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Year</th>
          <td mat-cell *matCellDef="let row">{{ row.yearLabel }}</td>
        </ng-container>

        <!-- Doc Type -->
        <ng-container matColumnDef="docType">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Document Type</th>
          <td mat-cell *matCellDef="let row">{{ row.doctType }}</td>
        </ng-container>

        <!-- Audit Status -->
        <!-- <ng-container matColumnDef="auditStatus">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Audit Status</th>
                <td mat-cell *matCellDef="let row">
                  {{ row.isAudited === 'audited' ? 'Audited' : 'UnAudited' }}
                </td>
              </ng-container> -->

        <ng-container matColumnDef="formUploadedOn">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Form Uploaded On</th>
          <td mat-cell *matCellDef="let row">
            {{ row.ulbSubmit | date: 'yyyy-MM-dd HH:mm:ss' }}
          </td>
        </ng-container>
        <ng-container matColumnDef="digitizedOn">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Digitized On</th>
          <td mat-cell *matCellDef="let row">
            {{ row.afsexcelfiles?.files[0]?.uploadedAt | date: 'yyyy-MM-dd HH:mm:ss' }}
          </td>
        </ng-container>
        <ng-container matColumnDef="requestIdLog">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>RequestId / Log</th>
          <td mat-cell *matCellDef="let row">
            {{ row.afsexcelfiles?.files[0]?.requestId }}
          </td>
        </ng-container>

        <!-- Header & Row -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

        <!-- No data row -->
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">
            No records found for selected filters.
          </td>
        </tr>
      </table>
    </div>

    <mat-paginator
      [pageSize]="10"
      [pageSizeOptions]="[5, 10, 25, 50]"
      showFirstLastButtons
    ></mat-paginator>
  </mat-card>
</div>
