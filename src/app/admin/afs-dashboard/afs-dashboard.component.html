<div class="dashboard-page">
    <div class="dashboard-layout">

        <!-- Filters -->
        <div class="filters filters-top">
            <button class="reset-filter" (click)="resetFilters()">Reset Filter</button>

            <p>State</p>
            <div class="custom-dropdown">
                <input type="text" [(ngModel)]="stateSearchText" (input)="selectedState = ''; stateDropdownOpen = true"
                    (focus)="stateDropdownOpen = true" placeholder="Search state..." class="state-search-box" />
                @if(stateDropdownOpen && filteredStates.length > 0) {
                <div class="dropdown-list scroll-box">
                    @for(s of filteredStates; track $index) {
                    <button class="dropdown-item" (click)="selectState(s)" [class.selected]="s._id === selectedState">
                        {{ s.name }}
                    </button>
                    }
                </div>
                }
            </div>

            <p>Population Category</p>
            <select [(ngModel)]="selectedPopulation" (change)="onPopulationOrStateChange()">
                <option value="">Select population category</option>
                @for(p of filters.populationCategories; track $index){
                <option [value]="p">{{ p }}</option>
                }
            </select>

            <p class="filter-label">City</p>
            <input type="text" [(ngModel)]="citySearchText" placeholder="Search city..." class="city-search-box" />

            @if(selectedState && selectedPopulation){
            <div>
                <div class="city-checkboxes scroll-box">
                    @for(c of filteredCities; track $index){
                    <label class="checkbox-item">
                        <input type="checkbox" [value]="c.name" [checked]="selectedCities.includes(c.name)"
                            (change)="toggleCitySelection(c.name, $any($event.target).checked)" />
                        <span>{{ c.name }}</span>
                    </label>
                    }
                </div>
            </div>
            }

            <p>Year</p>
            <select [(ngModel)]="selectedYear">
                <option value="">Select Year</option>
                @for(y of filters.years; track $index){
                <option [value]="y.name">{{ y.name }}</option>
                }
            </select>

            <p>Document Type</p>
            <div class="grouped-dropdown">
                @for(group of filters.documentTypes; track $index){
                <div>
                    <div class="group-heading">{{ group.heading }}</div>
                    @for(d of group.items; track $index){
                    <div class="group-option">
                        <label>
                            <input type="radio" name="docType" [value]="d.key" [(ngModel)]="selectedDocType"
                                (ngModelChange)="onDocTypeChange($event)" />
                            {{ d.name }}
                        </label>
                    </div>
                    }
                </div>
                }
            </div>

            @if(selectedDocType !== '16th_fc'){
            <div class="audited-radio-container radio-options">
                <label>
                    <input type="radio" name="auditStatus" [(ngModel)]="isAudited" value="audited" />
                    Audited
                </label>
                <label>
                    <input type="radio" name="auditStatus" [(ngModel)]="isAudited" value="unAudited" />
                    UnAudited
                </label>
            </div>
            }

            <button class="apply-btn" (click)="applyFilters()">Apply</button>
        </div>

        <div class="content-panel">
            <!-- Top Controls -->
            <div class="top-controls">
                <div class="metrics-box">
                    <div class="metrics-section">
                        <div class="metrics-item">
                            Files Digitized: <span class="number">{{ globalMetrics.digitizedFiles }}</span>
                        </div>
                        <div class="metrics-item">
                            Pages Digitized: <span class="number">{{ globalMetrics.digitizedPages }}</span>
                        </div>
                        <div class="metrics-item error">
                            Files Failed: <span class="number">{{ globalMetrics.failedFiles }}</span>
                        </div>
                        <div class="metrics-item error">
                            Pages Failed: <span class="number">{{ globalMetrics.failedFiles }}</span>
                        </div>
                        <div class="metrics-item success">
                            Successful Digitization: <span class="number">{{ getGlobalSuccessRate() }}%</span>
                        </div>
                    </div>
                </div>

                <button class="download-btn" (click)="downloadExcel()">Download</button>
                <div class="top-actions">
                    <button class="profile-icon" (click)="togglePopup()">üë§</button>
                </div>
            </div>

            <!-- Profile Popup -->
            @if(showPopup){
            <div class="profile-popup">
                <button class="close-btn" (click)="togglePopup()"> √ó </button>
                <div class="popup-content">
                    <div class="avatar-large">üë§</div>
                    <div><strong>Name:</strong> {{ fullName }}</div>
                    <div><strong>Email:</strong> {{ email }}</div>
                    <div><strong>Role:</strong> {{ role }}</div>
                    <div><strong>Last Login:</strong> {{ lastLoginTime | date:'short' }}</div>
                    <button class="logout-btn" (click)="logout()">Logout</button>
                </div>
            </div>
            }

            <div class="table-wrapper">
                <div class="main-content">

                    @if(!filtersApplied){
                    <div class="placeholder-section">
                        <div>
                            <h4>select filters on the left pane to see the files</h4>
                        </div>
                    </div>
                    }

                    @if(isLoading){
                    <div class="loader-overlay">
                        <div class="spinner"></div>
                        <p>Loading data...</p>
                    </div>
                    }

                    @if(isLoading){
                    <div class="loader-overlay">
                        <div class="spinner"></div>
                        <p>Please wait...</p>
                    </div>
                    }

                    @if(filtersApplied){
                    <div class="file-results">
                        <h3>Available Files</h3>
                        <div class="table-container">
                            <table class="afs-table">
                                <thead>
                                    <tr>
                                        <th>
                                            ALL <input type="checkbox" [(ngModel)]="selectAll"
                                                (change)="toggleSelectAll()" />
                                        </th>
                                        <th>State</th>
                                        <th>City
                                            <span class="sort-buttons">
                                                <button (click)="sortByCity('asc')">‚¨ÜÔ∏è</button>
                                                <button (click)="sortByCity('desc')">‚¨áÔ∏è</button>
                                            </span>
                                        </th>
                                        <th>ULB Code
                                            <span class="sort-buttons">
                                                <button (click)="sortByULBCode('asc')">‚¨ÜÔ∏è</button>
                                                <button (click)="sortByULBCode('desc')">‚¨áÔ∏è</button>
                                            </span>
                                        </th>
                                        <th>PDF DOCUMENT</th>
                                        <th>Form Status</th>
                                        <th>Digitize Status</th>
                                        <th>Form Uploaded On ...</th>
                                        <th>Form Digitized On ...</th>
                                        <th tabindex="-1">Request ID / Log</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if(filteredFiles.length === 0){
                                    <tr>
                                        <td colspan="10" class="no-results">No results found within selected filters
                                        </td>
                                    </tr>
                                    }
                                    @for(file of filteredFiles; track $index){
                                    <tr [ngClass]="{'active-row': activeRow === file}">
                                        <td>
                                            <input type="checkbox" [(ngModel)]="file.selected"
                                                (change)="updateSelection()" />
                                        </td>

                                        <td>{{ file.stateName }}</td>
                                        <td>{{ file.cityName }}</td>
                                        <td>{{ file.ulbCode }}</td>

                                        <td>
                                            <div class="content-wrapper1">
                                                <div class="ulb-file">
                                                    @if(file.previewUrl){
                                                    <a [href]="file.previewUrl" target="_blank"
                                                        (click)="setActiveRow(file); $event.stopPropagation()">{{
                                                        file.fileName }}</a>
                                                    @if(file.pageCount !== undefined){
                                                    <div class="page-count">({{ file.pageCount }} pages)</div>
                                                    }
                                                    } @else if(file.fileUrl){
                                                    <a [href]="storageBaseUrl + file.fileUrl" target="_blank"
                                                        (click)="setActiveRow(file); $event.stopPropagation()">{{
                                                        file.fileName }}</a>
                                                    @if(file.pageCount !== undefined){
                                                    <div class="page-count">({{ file.pageCount }} pages)</div>
                                                    }
                                                    } @else {
                                                    {{ file.fileName }}
                                                    @if(file.pageCount !== undefined){
                                                    <div class="page-count">({{ file.pageCount }} pages)</div>
                                                    }
                                                    }
                                                </div>

                                                @if(file.extraFiles && file.extraFiles.length > 0){
                                                <div class="afs-files">
                                                    @for(ef of file.extraFiles; track $index){
                                                    <div class="file-link afs-file">
                                                        <a [href]="ef.fileUrl" target="_blank"
                                                            (click)="setActiveRow(file); $event.stopPropagation()">{{
                                                            ef.fileName }}</a>
                                                        @if(ef.pageCount !== undefined){
                                                        <div class="page-count">({{ ef.pageCount }} pages)</div>
                                                        }
                                                    </div>
                                                    }
                                                </div>
                                                }

                                                <div style="margin-top: -14px;">
                                                    <button class="upload-btn" style="margin-bottom: 4px;"
                                                        (click)="setActiveRow(file); triggerFileInput(file)">
                                                        {{ file.extraFiles && file.extraFiles.length > 0 ? 'Re-upload' :
                                                        'Upload' }}
                                                    </button>
                                                    <input type="file" accept="application/pdf" style="display: none"
                                                        (change)="handleFileUpload($event, file)" #fileInput
                                                        [attr.data-id]="file.cityName + file.ulbCode" />
                                                </div>
                                            </div>
                                        </td>

                                        <td>
                                            <div class="digitize-status-wrapper">
                                                <div class="digitize-block ulb-block">
                                                    {{ file.statusText }}
                                                </div>
                                                @if(file.extraFiles && file.extraFiles.length > 0){
                                                <div class="digitize-block afs-block">N/A</div>
                                                }
                                            </div>
                                        </td>

                                        <td>
                                            <div class="digitize-status-wrapper">
                                                <div class="digitize-block ulb-block">
                                                    @if(hasExcelFile(file, 'ULB')){
                                                    DIGITIZED
                                                    @for(excel of getExcelFiles(file, 'ULB'); track $index){
                                                    <a [href]="excel.fileUrl" target="_blank">excelfile.xlsx</a>
                                                    }
                                                    } @else {
                                                    NOT DIGITIZED
                                                    }
                                                </div>

                                                @if(file.extraFiles && file.extraFiles.length > 0){
                                                <div class="digitize-block afs-block">
                                                    @if(hasExcelFile(file, 'AFS')){
                                                    DIGITIZED
                                                    @for(excel of getExcelFiles(file, 'AFS'); track $index){
                                                    <a [href]="excel.fileUrl" target="_blank">excelfile.xlsx</a>
                                                    }
                                                    } @else {
                                                    NOT DIGITIZED
                                                    }
                                                </div>
                                                }
                                            </div>
                                        </td>

                                        <td>
                                            <div class="digitize-status-wrapper"
                                                style="margin-top: 20px; margin-right: 12px;"
                                                [ngClass]="{'single-block': !file.uploadedAt}">
                                                <div class="digitize-block ulb-block" *ngIf="file.ulbSubmit">
                                                    {{ file.ulbSubmit | date:'short' }}
                                                </div>
                                                <div class="digitize-block ulb-block" *ngIf="!file.ulbSubmit">
                                                    Not Submitted
                                                </div>

                                                <div class="digitize-block afs-block" *ngIf="file.uploadedAt">
                                                    {{ file.uploadedAt | date:'short' }}
                                                </div>
                                            </div>
                                        </td>



                                        <td>
                                            <div class="timestamp-wrapper" style="margin-top: 20px; margin-right: 15px;"
                                                *ngIf="file.excelFiles && file.excelFiles.length > 0; else noFiles">
                                                <div class="timestamp-block" *ngFor="let excel of file.excelFiles">
                                                    <span>
                                                        {{ excel && excel.uploadedAt ? (excel.uploadedAt |
                                                        date:'d/M/yyyy, h:mm a') : 'N/A' }}
                                                    </span>
                                                </div>
                                            </div>

                                            <ng-template #noFiles>
                                                <div class="digitize-status-wrapper single-block"
                                                    style="margin-top: 30px;">
                                                    <div class="digitize-block ulb-block">N/A</div>
                                                </div>
                                            </ng-template>
                                        </td>




                                        <td>
                                            <div class="digitize-status-wrapper">
                                                <div class="digitize-block ulb-block"> <a href="javascript:void(0)"
                                                        (click)="viewLogs(file['ulbId'])"> View Logs</a>
                                                </div>

                                            </div>
                                        </td>
                                    </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div *ngIf="selectedFilesCount > 0" class="selection-summary">
                            <strong>{{ totalSelectedPages }} pages</strong> from
                            <strong>{{ selectedFilesCount }} PDF file(s)</strong> selected to digitize

                        </div>

                        <div>

                            <button class="digitize-btn" (click)="openDigitizePopup()">Digitize & Download</button>
                        </div>
                        <!-- Digitize Popup -->
                        <div class="popup-overlay" *ngIf="showDigitizePopup">
                            <div class="popup-box">
                                <h3>Confirm Digitization</h3>
                                <p>
                                    You have selected <strong>{{ selectedFilesCount }}</strong> file(s)
                                    containing <strong>{{ totalSelectedPages }}</strong> pages.
                                </p>

                                <div *ngIf="digitizeStatus === ''">
                                    <button class="proceed-btn" (click)="proceedDigitization()">Proceed</button>
                                    <button class="cancel-btn" (click)="closeDigitizePopup()">Cancel</button>
                                </div>

                                <div *ngIf="digitizeStatus === 'done'">
                                    <p style="color: green; font-weight: bold;"> Done</p>
                                    <button (click)="closeDigitizePopup()">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    }

                </div>
            </div>
        </div>
    </div>
</div>